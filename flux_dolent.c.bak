#include <stdio.h>
#include "rk78.h"
#include "flux.h"

/**
 * Calcula el flux d'un sistema d'EDOs des de temps t fins t+T
 * usant rk78().
 */
int flux (double *t, double x[], double *h, double T, double pasmin, double pasmax, double tol, int npasmax, int n, int (*camp)(int n, double t, double x[], double f[], void *prm), void *prm) {
    int i=0,j;
    double taux=*t,xaux[n],haux=*h;
    double tmax=*t+T;
    
    for (j=0; j<n; j++)
        xaux[j]=x[j];
    
    while (i<npasmax) {

        /* fem un pas de prova */
        rk78(&taux,xaux,&haux,pasmin,pasmax,tol,n,camp,prm);
        /* si el pas ha sigut bo, el fem */
        if (taux < tmax) { 
            *t=taux;
            for (j=0; j<n; j++)
                x[j]=xaux[j];
            *h=haux;
            i++;
        }
        /* si el pas és massa gran, fem exactament el que falta */
        else {
            /* faig el pas auxiliar forçat */
            taux=*t;
            for (j=0; j<n; j++)
                xaux[j]=x[j];
            haux=tmax-*t;
            rk78(&taux,xaux,&haux,haux,pasmax,tol,n,camp,prm);
            /* però em vull quedar amb el pas suggerit sense forçar */
            rk78(t,x,h,pasmin,pasmax,tol,n,camp,prm);
            *t=taux;
            for (j=0; j<n; j++)
                x[j]=xaux[j];
            return 0;
        }
        
    }
    return -1;
}